<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dad & Son Fitness Challenge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .header h1 {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .progress-section {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .progress-title {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 24px;
            color: #1f2937;
        }
        
        .progress-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .progress-card {
            padding: 16px;
            border-radius: 12px;
            color: white;
            position: relative;
        }
        
        .progress-card.dad {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .progress-card.son {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .progress-header {
            margin-bottom: 12px;
        }
        
        .progress-label {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        .progress-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .progress-bar {
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-bar.dad {
            background: #059669;
        }
        
        .progress-bar.son {
            background: #2563eb;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 6px;
            transition: width 0.5s ease;
        }
        
        .goal-completed {
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }
        
        .stat-card {
            padding: 12px;
            border-radius: 8px;
            color: white;
            text-align: center;
        }
        
        .stat-card.dad-streak {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .stat-card.dad-sessions {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .stat-card.son-streak {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .stat-card.son-sessions {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }
        
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .stat-value {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .logger-section {
            background: #f9fafb;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .logger-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 16px;
            color: #1f2937;
        }
        
        .user-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 16px;
        }
        
        .user-tab-group {
            background: #e5e7eb;
            border-radius: 8px;
            padding: 4px;
            display: flex;
        }
        
        .user-tab {
            padding: 12px 32px;
            border-radius: 6px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 1rem;
            height: 48px;
            display: flex;
            align-items: center;
        }
        
        .user-tab.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .logger-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .form-input, .form-select {
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
            height: 48px;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .add-button {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 1rem;
            flex: 1;
            height: 48px;
        }
        
        .add-button:hover:not(:disabled) {
            background: #2563eb;
        }
        
        .add-button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .undo-button {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 1rem;
            height: 48px;
            margin-left: 8px;
        }
        
        .undo-button:hover:not(:disabled) {
            background: #dc2626;
        }
        
        .undo-button:disabled {
            background: #fca5a5;
            cursor: not-allowed;
        }

        .button-group {
            display: flex;
            align-items: center;
        }
        
        .sessions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .sessions-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
        }
        
        .sessions-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 16px;
            color: #1f2937;
        }
        
        .sessions-list {
            max-height: 240px;
            overflow-y: auto;
        }
        
        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .session-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .session-emoji {
            font-size: 1.2rem;
        }
        
        .session-exercise {
            font-weight: 500;
        }
        
        .session-reps {
            color: #3b82f6;
            font-weight: bold;
        }
        
        .session-time {
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .empty-sessions {
            text-align: center;
            color: #6b7280;
            padding: 32px;
        }
        
        .export-section {
            text-align: center;
        }
        
        .export-button {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 32px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-button:hover {
            background: #059669;
        }
        
        .export-description {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 8px;
        }
        
        @media (max-width: 768px) {
            .progress-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .logger-form {
                grid-template-columns: 1fr;
            }
            
            .sessions-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <!-- Header -->
            <div class="header">
                <h1>üí™ Dad & Son Fitness Challenge üî•</h1>
                <p>üéØ Daily Goal: 141 Reps üéØ</p>
                <p>üíØ Stay Strong Together! üíØ</p>
                
                <!-- Family ID Section -->
                <div id="family-setup" style="margin-top: 20px; padding: 16px; background: #f9fafb; border-radius: 8px;">
                    <div style="margin-bottom: 12px; font-weight: 500;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family ID:</div>
                    <div style="display: flex; gap: 12px; align-items: center; justify-content: center;">
                        <input type="text" id="family-id-input" placeholder="Enter your family name" 
                               style="padding: 8px 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 1rem;" />
                        <button id="connect-button" onclick="connectFamily()" 
                                style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            üîó Connect
                        </button>
                    </div>
                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 8px; text-align: center;">
                        Both devices need to use the same Family ID to sync data
                    </div>
                </div>
                
                <div id="connected-status" style="display: none; margin-top: 20px; padding: 12px; background: #dcfce7; border-radius: 8px; text-align: center; color: #16a34a; font-weight: 500;">
                    ‚úÖ Connected as: <span id="current-family-id"></span>
                </div>
            </div>

            <!-- Combined Progress View -->
            <div class="progress-section">
                <div class="progress-title">üèÜ Today's Challenge Progress üèÜ</div>
                
                <!-- Progress Bars -->
                <div class="progress-grid">
                    <!-- Dad's Progress -->
                    <div class="progress-card dad">
                        <div class="progress-header">
                            <div class="progress-label">üë® Dad's Progress</div>
                            <div class="progress-value" id="dad-progress">0/141 üí™</div>
                        </div>
                        <div class="progress-bar dad">
                            <div class="progress-fill" id="dad-progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="goal-completed" id="dad-goal" style="display: none;">üéâ GOAL COMPLETED! üéâ</div>
                    </div>

                    <!-- Son's Progress -->
                    <div class="progress-card son">
                        <div class="progress-header">
                            <div class="progress-label">üë¶ Son's Progress</div>
                            <div class="progress-value" id="son-progress">0/141 üí™</div>
                        </div>
                        <div class="progress-bar son">
                            <div class="progress-fill" id="son-progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="goal-completed" id="son-goal" style="display: none;">üéâ GOAL COMPLETED! üéâ</div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card dad-streak">
                        <div class="stat-label">üë® Dad's Streak</div>
                        <div class="stat-value" id="dad-streak">0 days üèÜ</div>
                    </div>
                    <div class="stat-card dad-sessions">
                        <div class="stat-label">üë® Dad's Sessions</div>
                        <div class="stat-value" id="dad-sessions">0 üíØ</div>
                    </div>
                    <div class="stat-card son-streak">
                        <div class="stat-label">üë¶ Son's Streak</div>
                        <div class="stat-value" id="son-streak">0 days üèÜ</div>
                    </div>
                    <div class="stat-card son-sessions">
                        <div class="stat-label">üë¶ Son's Sessions</div>
                        <div class="stat-value" id="son-sessions">0 üíØ</div>
                    </div>
                </div>
            </div>

            <!-- Exercise Logger -->
            <div class="logger-section">
                <div class="logger-title">üéØ Log Workout üí™</div>
                
                <!-- User Selection -->
                <div class="user-tabs">
                    <div class="user-tab-group">
                        <button class="user-tab active" id="dad-tab" onclick="selectUser('Dad')">üë® Dad</button>
                        <button class="user-tab" id="son-tab" onclick="selectUser('Son')">üë¶ Son</button>
                    </div>
                </div>

                <div class="logger-form">
                    <div class="form-group">
                        <label class="form-label">Exercise</label>
                        <select class="form-select" id="exercise-select">
                            <option value="squats">üèãÔ∏è Squats</option>
                            <option value="sit-ups">ü§∏ Sit-ups</option>
                            <option value="pushups">üí™ Pushups</option>
                            <option value="Bulgarian squats">ü¶µ Bulgarian squats</option>
                            <option value="lunges">üèÉ Lunges</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Reps</label>
                        <input type="number" class="form-input" id="reps-input" placeholder="Enter reps" min="1">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">&nbsp;</label>
                        <div class="button-group">
                            <button class="add-button" id="add-button" onclick="addWorkout()">
                                üöÄ Add Workout for <span id="current-user">Dad</span> üöÄ
                            </button>
                            <button class="undo-button" id="undo-button" onclick="undoLastWorkout()" disabled>
                                ‚Ü∂ Undo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Sessions -->
            <div class="sessions-grid">
                <div class="sessions-card">
                    <div class="sessions-title">üî• Dad's Today's Sessions üíØ</div>
                    <div class="sessions-list" id="dad-sessions-list">
                        <div class="empty-sessions">üò¥ No workouts logged today</div>
                    </div>
                </div>
                <div class="sessions-card">
                    <div class="sessions-title">üî• Son's Today's Sessions üíØ</div>
                    <div class="sessions-list" id="son-sessions-list">
                        <div class="empty-sessions">üò¥ No workouts logged today</div>
                    </div>
                </div>
            </div>

            <!-- Export Button -->
            <div class="export-section">
                <button class="export-button" onclick="exportToCSV()">
                    üìä Export All Data to CSV üìÅ
                </button>
                <div class="export-description">
                    üíæ Downloads complete workout history for both Dad & Son
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCEqCtIKf6jBd0-bamD3zf8Jze4G_AV7Z4",
            authDomain: "dad-v-son-fitness-challenge.firebaseapp.com",
            projectId: "dad-v-son-fitness-challenge",
            storageBucket: "dad-v-son-fitness-challenge.firebasestorage.app",
            messagingSenderId: "1007734733222",
            appId: "1:1007734733222:web:96698a7aa2303425033767",
            measurementId: "G-Z55FT3W2VC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase functions available globally
        window.db = db;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
    </script>

    <script>
        // Global state
        let currentUser = 'Dad';
        let workoutData = {};
        let familyId = null;
        
        const exercises = {
            'squats': 'üèãÔ∏è',
            'sit-ups': 'ü§∏',
            'pushups': 'üí™',
            'Bulgarian squats': 'ü¶µ',
            'lunges': 'üèÉ'
        };
        
        const today = new Date().toISOString().split('T')[0];

        // Connect to family
        async function connectFamily() {
            const familyIdInput = document.getElementById('family-id-input');
            const inputValue = familyIdInput.value.trim();
            
            if (!inputValue) {
                alert('Please enter a family ID');
                return;
            }
            
            familyId = inputValue.toLowerCase().replace(/[^a-z0-9]/g, '');
            
            try {
                // Save family ID locally
                localStorage.setItem('familyId', familyId);
                
                // Initialize data structure
                await initializeFirestoreData();
                
                // Set up real-time listener
                setupRealtimeListener();
                
                // Update UI
                document.getElementById('family-setup').style.display = 'none';
                document.getElementById('connected-status').style.display = 'block';
                document.getElementById('current-family-id').textContent = inputValue;
                
            } catch (error) {
                console.error('Error connecting to family:', error);
                alert('Error connecting: ' + error.message + '. Please check the browser console for details.');
            }
        }

        // Initialize Firestore data
        async function initializeFirestoreData() {
            if (!familyId) return;
            
            console.log('Initializing Firestore data for family:', familyId);
            
            try {
                const docRef = doc(db, 'families', familyId);
                console.log('Getting document...');
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    console.log('Document does not exist, creating new one...');
                    // Create new family document
                    const initialData = {
                        Dad: {},
                        Son: {},
                        lastUpdated: new Date().toISOString()
                    };
                    await setDoc(docRef, initialData);
                    console.log('New document created successfully');
                    workoutData = { Dad: {}, Son: {} };
                } else {
                    console.log('Loading existing document...');
                    // Load existing data
                    const data = docSnap.data();
                    workoutData = {
                        Dad: data.Dad || {},
                        Son: data.Son || {}
                    };
                    console.log('Existing data loaded successfully');
                }
            } catch (error) {
                console.error('Error in initializeFirestoreData:', error);
                throw error;
            }
            
            // Ensure today's data exists
            ['Dad', 'Son'].forEach(user => {
                if (!workoutData[user][today]) {
                    workoutData[user][today] = {
                        sessions: [],
                        totalReps: 0,
                        goalMet: false
                    };
                }
            });
            
            // Load saved user selection
            try {
                const savedUser = localStorage.getItem('selectedUser');
                if (savedUser && (savedUser === 'Dad' || savedUser === 'Son')) {
                    currentUser = savedUser;
                }
            } catch (error) {
                console.error('Error loading saved user:', error);
            }
            
            updateDisplay();
            selectUser(currentUser);
            updateUndoButton();
        }

        // Set up real-time listener
        function setupRealtimeListener() {
            if (!familyId) return;
            
            const docRef = doc(db, 'families', familyId);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    workoutData = {
                        Dad: data.Dad || {},
                        Son: data.Son || {}
                    };
                    
                    // Ensure today's data exists
                    ['Dad', 'Son'].forEach(user => {
                        if (!workoutData[user][today]) {
                            workoutData[user][today] = {
                                sessions: [],
                                totalReps: 0,
                                goalMet: false
                            };
                        }
                    });
                    
                    updateDisplay();
                    updateUndoButton();
                }
            });
        }

        // Save data to Firestore
        async function saveData() {
            if (!familyId) return;
            
            try {
                const docRef = doc(db, 'families', familyId);
                await setDoc(docRef, {
                    Dad: workoutData.Dad,
                    Son: workoutData.Son,
                    lastUpdated: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        // Initialize data
        function initializeData() {
            // Check if family ID is already saved
            try {
                const savedFamilyId = localStorage.getItem('familyId');
                if (savedFamilyId) {
                    familyId = savedFamilyId;
                    document.getElementById('family-id-input').value = savedFamilyId;
                    connectFamily();
                }
            } catch (error) {
                console.error('Error loading saved family ID:', error);
            }
        }

        // Select user for logging
        function selectUser(user) {
            currentUser = user;
            document.getElementById('dad-tab').classList.toggle('active', user === 'Dad');
            document.getElementById('son-tab').classList.toggle('active', user === 'Son');
            document.getElementById('current-user').textContent = user;
            updateUndoButton();
            
            // Save user selection to localStorage
            try {
                localStorage.setItem('selectedUser', user);
            } catch (error) {
                console.error('Error saving user selection:', error);
            }
        }

        // Add workout
        async function addWorkout() {
            if (!familyId) {
                alert('Please connect to your family first!');
                return;
            }
            
            const exercise = document.getElementById('exercise-select').value;
            const repsInput = document.getElementById('reps-input');
            const reps = parseInt(repsInput.value);
            
            if (!reps || reps <= 0) return;

            const session = {
                exercise: exercise,
                reps: reps,
                time: new Date().toLocaleTimeString(),
                timestamp: new Date().toISOString()
            };

            if (!workoutData[currentUser][today]) {
                workoutData[currentUser][today] = { sessions: [], totalReps: 0, goalMet: false };
            }
            
            const userToday = workoutData[currentUser][today];
            userToday.sessions.push(session);
            userToday.totalReps += reps;
            userToday.goalMet = userToday.totalReps >= 141;

            repsInput.value = '';
            
            // Save to Firestore
            await saveData();
            
            // Update display immediately for responsiveness
            updateDisplay();
            
            // Enable undo button
            updateUndoButton();
        }

        // Get today's progress for user
        function getTodaysProgress(user) {
            const todayData = workoutData[user] && workoutData[user][today];
            return todayData ? todayData.totalReps : 0;
        }

        // Get today's sessions for user
        function getTodaysSessions(user) {
            const todayData = workoutData[user] && workoutData[user][today];
            return todayData ? todayData.sessions : [];
        }

        // Calculate streak for user
        function calculateStreak(user) {
            const userData = workoutData[user] || {};
            const dates = Object.keys(userData).sort().reverse();
            let streak = 0;
            
            for (const date of dates) {
                if (userData[date] && userData[date].goalMet) {
                    streak++;
                } else {
                    break;
                }
            }
            return streak;
        }

        // Update display
        function updateDisplay() {
            ['Dad', 'Son'].forEach(user => {
                const progress = getTodaysProgress(user);
                const sessions = getTodaysSessions(user);
                const streak = calculateStreak(user);
                const percentage = Math.min((progress / 141) * 100, 100);
                
                const userLower = user.toLowerCase();
                
                // Update progress
                document.getElementById(`${userLower}-progress`).textContent = `${progress}/141 üí™`;
                document.getElementById(`${userLower}-progress-fill`).style.width = `${percentage}%`;
                document.getElementById(`${userLower}-goal`).style.display = progress >= 141 ? 'block' : 'none';
                
                // Update stats
                document.getElementById(`${userLower}-streak`).textContent = `${streak} days üèÜ`;
                document.getElementById(`${userLower}-sessions`).textContent = `${sessions.length} üíØ`;
                
                // Update sessions list
                const sessionsList = document.getElementById(`${userLower}-sessions-list`);
                if (sessions.length === 0) {
                    sessionsList.innerHTML = '<div class="empty-sessions">üò¥ No workouts logged today</div>';
                } else {
                    sessionsList.innerHTML = sessions.map(session => `
                        <div class="session-item">
                            <div class="session-info">
                                <span class="session-emoji">${exercises[session.exercise] || 'üí™'}</span>
                                <span class="session-exercise">${session.exercise}</span>
                                <span class="session-reps">${session.reps} reps</span>
                            </div>
                            <span class="session-time">‚è∞ ${session.time}</span>
                        </div>
                    `).join('');
                }
            });
        }

        // Undo last workout
        async function undoLastWorkout() {
            if (!familyId) {
                alert('Please connect to your family first!');
                return;
            }
            
            const userToday = workoutData[currentUser][today];
            if (!userToday || userToday.sessions.length === 0) {
                return; // No sessions to undo
            }
            
            // Remove the last session
            const lastSession = userToday.sessions.pop();
            userToday.totalReps -= lastSession.reps;
            userToday.goalMet = userToday.totalReps >= 141;
            
            // Save to Firestore
            await saveData();
            
            // Update display immediately for responsiveness
            updateDisplay();
            updateUndoButton();
        }

        // Update undo button state
        function updateUndoButton() {
            const undoButton = document.getElementById('undo-button');
            const userToday = workoutData[currentUser] && workoutData[currentUser][today];
            const hasWorkouts = userToday && userToday.sessions && userToday.sessions.length > 0;
            
            undoButton.disabled = !hasWorkouts;
        }

        // Export to CSV
        function exportToCSV() {
            const csvData = [];
            csvData.push(['Date', 'User', 'Exercise', 'Reps', 'Time', 'Daily Total', 'Goal Met']);

            ['Dad', 'Son'].forEach(user => {
                const userData = workoutData[user] || {};
                const sortedDates = Object.keys(userData).sort();
                
                sortedDates.forEach(date => {
                    const dayData = userData[date];
                    if (dayData.sessions.length === 0) {
                        csvData.push([date, user, 'No workouts', 0, '', dayData.totalReps, dayData.goalMet ? 'Yes' : 'No']);
                    } else {
                        dayData.sessions.forEach((session, index) => {
                            csvData.push([
                                date, user, session.exercise, session.reps, session.time,
                                index === 0 ? dayData.totalReps : '', 
                                index === 0 ? (dayData.goalMet ? 'Yes' : 'No') : ''
                            ]);
                        });
                    }
                });
            });

            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `fitness-data-${today}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Event listeners
        document.getElementById('reps-input').addEventListener('input', function() {
            const hasValue = this.value && parseInt(this.value) > 0;
            document.getElementById('add-button').disabled = !hasValue;
        });

        document.getElementById('reps-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addWorkout();
            }
        });

        document.getElementById('family-id-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                connectFamily();
            }
        });

        // Initialize app
        initializeData();
    </script>
</body>
</html>